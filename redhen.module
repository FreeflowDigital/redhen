<?php

/**
 * @file
 * Defines basic functionality common to all parts of the Redhen CRM.
 */

// Definitions
define('REDHEN_STATE_ACTIVE', 1);
define('REDHEN_STATE_ARCHIVED', 0);

function redhen_menu() {
  $items = array();

  // Menu items that are basically just menu blocks.
  $items['redhen'] = array(
    'title' => 'RedHen CRM',
    'description' => 'RedHen CRM home',
    'weight' => -8,
    'page callback' => 'redhen_admin_menu_block_page',
    'menu_name' => 'navigation',
    'access arguments' => array('access administration pages'),
    'file' => 'includes/redhen.admin.inc',
  );
  $items['admin/structure/redhen'] = array(
    'title' => 'RedHen CRM',
    'description' => 'Administer RedHen CRM items, such as contact, group types, etc.',
    'weight' => -8,
    'page callback' => 'redhen_admin_menu_block_page',
    'menu_name' => 'navigation',
    'access arguments' => array('access administration pages'),
    'file' => 'includes/redhen.admin.inc',
    'menu_name' => 'management',
  );

  return $items;
}

/**
 * Wrapper for devel_load_object which is in an include file.
 */
function redhen_devel_load_object($type, $object, $name = NULL) {
  if (module_exists('devel')) {
    module_load_include('inc', 'devel', 'devel.pages');
    return devel_load_object($type, $object, $name);
  }
}

/**
 * Wrapper function for devel_render_object which is in an include file.
 */
function redhen_devel_render_object($type, $object, $name = NULL) {
  if (module_exists('devel')) {
    module_load_include('inc', 'devel', 'devel.pages');
    return devel_render_object($type, $object, $name);
  }
}

/**
 * Implements hook_theme().
 */
function redhen_theme() {
  return array(
    'redhen_property_field' => array(
      'variables' => array(
        'label_hidden' => FALSE,
        'title_attributes' => NULL,
        'label' => '',
        'content_attributes' => NULL,
        'items' => array(),
        'item_attributes' => array(array()),
        'classes' => '',
        'attributes' => '',
      )
    ),
  );
}

/**
 * Theme function for redhen properties. Simple wrapper around theme_field
 * that sets default values and ensures proeprties render consistently with
 * fields.
 */
function theme_redhen_property_field($variables) {
  return theme_field($variables);
}

/**
 * Executes a filter query return a result set filtered by the provided
 * attributes. Used to filter Redhen entity list pages.
 *
 * @param string $entity_type
 * @param array $header
 *   Header array for sorting. Should match the table header used in output.
 * @param string $bundle
 * @param array $properties
 * @param array $fields
 * @param int $items_page
 *
 * @return array
 */
function redhen_filter_query($entity_type, $header, $bundle = '', $properties = array(), $fields = array(), $items_page = 10) {
  $query = new EntityFieldQuery();

    // build the query
  $query
    ->entityCondition('entity_type', $entity_type, '=')
    ->tablesort($header)
    ->pager($items_page);

  // set the bundle
  if (!empty($bundle)) {
    $query->entityCondition('bundle', $bundle, '=');
  }

  // add prop filters
  foreach($properties as $key => $value) {
    if ($value != '') {
      $query->propertyCondition($key, $value, '=');
    }
  }

  // add field filters
  foreach($fields as $key => $value) {
    if ($value != '') {
      $query->fieldCondition($key, 'value', $value, '=');
    }
  }

  return $query->execute();
}
