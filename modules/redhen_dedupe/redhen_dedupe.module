<?php

/**
 * Implements hook_menu().
 */
function redhen_dedupe_menu() {
  $items['redhen/dedupe'] = array(
    'title' => 'Find duplicate contacts',
    'page callback' => 'redhen_dedupe_list_page',
    'access arguments' => array('administer redhen contacts'),
    'type' => MENU_NORMAL_ITEM,
  );
  $items['redhen/dedupe/merge/%'] = array(
    'title' => 'Select a primary contact',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('redhen_dedupe_merge_form', 3),
    'access arguments' => array('administer redhen contacts'),
    'file' => 'includes/redhen_dedupe.form.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  $items['redhen/dedupe/merge_details/%/%'] = array(
    'title' => 'Select a primary contact',
    'page callback' => 'drupal_get_form',
    'page arguments' => array('redhen_dedupe_merge_details_form', 3, 4),
    'access arguments' => array('administer redhen contacts'),
    'file' => 'includes/redhen_dedupe.form.inc',
    'type' => MENU_NORMAL_ITEM,
  );
  return $items;
}

/**
 * Page callback for listing duplicate contacts.
 *
 * @return array
 *   Render array for a table of duplicates.
 */
function redhen_dedupe_list_page() {
  $results = FALSE;
  $contacts = array();
  $properties = array('first_name', 'last_name');
  if (!isset($_POST['form_id'])) {
    if (isset($_GET['properties'])) {
      $properties = $_GET['properties'];
    }
    if (!empty($properties)) {
      $results = redhen_dedupe_get_duplicates($properties);
    }
  }

  if (!empty($results)) {
    $message = t('The following sets of duplicate contacts have been found. Select the corresponding merge action to merge contact records.');
    $info = entity_get_property_info('redhen_contact');

    $rows = array();

    // Build our header array from the selected properties.
    $header = array(t('Count'), '');
    foreach ($properties as $property) {
      array_unshift($header, $info['properties']{$property}['label']);
    }

    // Display each result basing our row on the selected properties.
    foreach ($results as $result) {
      $col = array();
      foreach ($properties as $property) {
        $col[] = $result->{$property};
      }
      $col[] = $result->count;
      $col[] = l(t('merge'), 'redhen/dedupe/merge/' . $result->ids);

      $rows[] = $col;
    }

    $contacts = array(
      '#theme' => 'table',
      '#header' => $header,
      '#rows' => $rows,
    );
  }
  else {
    $message = t('There are no duplicate contacts based on the selected properties. Expand your search or relax, you have no duplicates!');
  }

  return array(
    'form' => drupal_get_form('redhen_dedupe_filter_form', $properties),
    'message' => array('#markup' => $message),
    'contacts' => $contacts,
  );
}

/**
 * Dedupe filter form.
 */
function redhen_dedupe_filter_form($form, &$form_state, $properties) {
  $info = entity_get_property_info('redhen_contact');
  foreach ($info['properties'] as $name => $property) {
    if (isset($property['schema field']) && !in_array($name, array('contact_id', 'revision_id'))) {
      $options[$name] = $property['label'];
    }
  }

  $form['properties'] = array(
    '#title' => t('Contact properties'),
    '#type' => 'checkboxes',
    '#options' => $options,
    '#default_value' => $properties,
    '#required' => TRUE,
    '#description' => t('Selected properties will be used to query duplicates. E.g., selecting first and last name will look for contacts with the same first and last names.'),
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Submit'),
  );

  return $form;
}

/**
 * Submit handler for redhen_contact_filter_form().
 */
function redhen_dedupe_filter_form_submit($form, &$form_state) {
  $query = array('properties' => array_filter($form_state['values']['properties']));
  $form_state['redirect'] = array($_GET['q'], array('query' => $query));
}

/**
 * Get duplicate contacts.
 *
 * @return array
 *   Array of objects containing first, last, and ids.
 */
function redhen_dedupe_get_duplicates($properties) {
  $query = db_select('redhen_contact', 'rc');
  $query->addTag('redhen_dedupe');
  $query->addExpression('COUNT(*)', 'count');
  $query->addExpression('GROUP_CONCAT(contact_id SEPARATOR \',\')', 'ids');
  $query->havingCondition('count', '1', '>');

  foreach ($properties as $property) {
    $query->addField('rc', $property);
    $query->groupBy($property);
  }

  return $query->execute()->fetchAll();
}

/**
 * Merge values from contacts into master contact and handle related entities.
 *
 * @param $master
 *   The master RedHen Contact.
 * @param array $contacts
 *   The contacts being merged into the master.
 * @param array $values
 *   Values to update the master contact with.
 * @param array $related_entities
 *   Array of entity types to update to the master contact.
 * @oaram bool $archive
 *   If TRUE, archive dead contacts instead of deleting them.
 *
 * @return boolean
 */
function redhen_dedupe_merge($master, $contacts, $values, $related_entities, $archive = TRUE ) {
  $master_wrapper = entity_metadata_wrapper('redhen_contact', $master);
  $master_id = $master_wrapper->internalIdentifier();

  $transaction = db_transaction();
  try {
    // Iterate through all contacts and update or delete related entities.
    foreach ($contacts as $contact) {
      $contact_id = $contact->internalIdentifier();
      // Don't act on the master contact.
      if ($contact_id == $master_id) {
        continue;
      }

      // Update related entities:
      foreach ($related_entities as $entity_type) {
        switch ($entity_type) {
          case 'redhen_note':
          case 'redhen_engagement':
          case 'redhen_membership':
            $query = new EntityFieldQuery();
            $query->entityCondition('entity_type', $entity_type);
            $query->propertyCondition('entity_type', 'redhen_contact');
            $query->propertyCondition('entity_id', $contact_id);
            $result = $query->execute();
            $rel_entities = entity_load($entity_type, array_keys($result[$entity_type]));
            foreach ($rel_entities as $rel_entity) {
              $rel_entity->entity_id = $master_id;
              entity_save($entity_type, $rel_entity);
            }
            break;

          case 'relation':

            break;

          // @TODO entity_reference
        }

      }

      // Archive or delete the duplicate contact.
      if ($archive) {
        $contact->state = REDHEN_STATE_ARCHIVED;
        $contact->save();
      }
      else {
        entity_delete('redhen_contact', $contact_id);
      }
    }

    // Set the new values on the master contact
    foreach ($values as $id => $value) {
      $master_wrapper->{$id}->set($value);
    }

    $master_wrapper->save();

    return TRUE;
  }
  catch (Exception $e) {
    $transaction->rollback();
    watchdog_exception('redhen_dedupe', $e);
  }
}
