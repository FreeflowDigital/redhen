<?php

/**
 * @file
 * Contains redhen_contact.module..
 */

use Drupal\Core\Routing\RouteMatchInterface;
use Drupal\redhen_contact\Entity\ContactType;
use Drupal\redhen_contact\Entity\Contact;

/**
 * Denotes that the contact is not active.
 */
const REDHEN_CONTACT_INACTIVE = 0;

/**
 * Denotes that the node is active.
 */
const REDHEN_CONTACT_ACTIVE = 1;

/**
 * Implements hook_help().
 */
function redhen_contact_help($route_name, RouteMatchInterface $route_match) {
  switch ($route_name) {
    // Main module help for the redhen_contact module.
    case 'help.page.redhen_contact':
      $output = '';
      $output .= '<h3>' . t('About') . '</h3>';
      $output .= '<p>' . t('Defines the base contact entity and features.') . '</p>';
      return $output;

    default:
  }
}

/**
 * Implements hook_theme().
 */
function redhen_contact_theme() {
  $theme = [];
  $theme['redhen_contact'] = [
    'render element' => 'elements',
    'file' => 'redhen_contact.page.inc',
    'template' => 'redhen_contact',
  ];
  $theme['redhen_contact_content_add_list'] = [
    'render element' => 'content',
    'variables' => ['content' => NULL],
    'file' => 'redhen_contact.page.inc',
  ];
  return $theme;
}

/**
 * Return an associative array of contact types to be used as an options list.
 *
 * @return array
 *   Keyed by name with a label value.
 */
function redhen_contact_type_options_list() {
  $options = array();
  foreach (ContactType::loadMultiple() as $type) {
    $options[$type->id()] = $type->label();
  }

  return $options;
}

/**
 * Implements hook_form_FORM_ID_alter() on the user_register_form.
 */
function redhen_contact_form_user_register_form_alter(&$form, \Drupal\Core\Form\FormStateInterface $form_state, $form_id) {

  // Get Redhen Contact settings.
  $config = \Drupal::config('redhen_contact.settings');
  // Check whether we should create a Contact on User registration.
  if ($config->get('connect_users')) {

    // Get menu item to check for overridden Contact Type parameter, but only
    // when a user is registering from user/register.
    $url_exploded = array_slice(explode('/', \Drupal::request()->getRequestUri()), 1);
    if ($url_exploded[0] == 'user' && $url_exploded[1] == 'register' && isset($url_exploded[2])) {
      $contact_type = $url_exploded[2];
    }
    else {
      // If a parameter was not passed, use the default contact type.
      $contact_type = $config->get('registration_type');
    }

    // If a valid contact type was found, embed fields from the Contact Type on
    // the user registration form.
    $types = redhen_contact_type_options_list();
    if (array_key_exists($contact_type, $types)) {
      $contact_object = Contact::create(['type' => $contact_type]);
      _redhen_contact_user_embed_contact_form($form, $form_state, $contact_object);
      // Hide the Contact email field, we will use the user mail field.
      $form['redhen_contact']['form']['redhen_contact_email']['#access'] = FALSE;
      // Add a validation handler for validating the Contact form data.
      $form['#validate'][] = 'redhen_contact_user_registration_validate';
      // Add a submit handler for handling the Contact form data.
      $form['#submit'][] = 'redhen_contact_user_registration_submit';
    }
    else {
      drupal_set_message(t('Invalid RedHen contact type parameter.'));
    }
  }
}

/**
 * Helper function to embed a contact form on a user form.
 *
 * Usage note: make sure to add a submit handler, otherwise this form data will
 * just be ignored.
 *
 * @param array $form
 *   Form array.
 * @param array $form_state
 *   Form state array.
 * @param Contact $contact
 *   The Contact to build the form on.
 */
function _redhen_contact_user_embed_contact_form(&$form, &$form_state, Contact $contact) {

  // Get Contact form.
  $form['redhen_contact'] = array(
    '#type' => 'fieldset',
    '#title' => t('%type Contact information', array('%type' => ucfirst($contact->bundle()))),
    'form' => \Drupal::service('entity.form_builder')->getForm($contact, 'add'),
  );

  // Unset the contact forms action, we will use the parent form's actions.
  unset($form['redhen_contact']['form']['actions']);
}

// @todo - add redhen_contact_user_registration_validate && redhen_contact_user_registration_submit functions
